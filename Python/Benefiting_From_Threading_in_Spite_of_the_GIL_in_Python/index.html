
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>Benefiting From Threading in Spite of the GIL in Python - Uriya Harpeness' Miscellaneous Things</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#benefiting-from-threading-in-spite-of-the-gil-in-python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Uriya Harpeness&#39; Miscellaneous Things" class="md-header__button md-logo" aria-label="Uriya Harpeness' Miscellaneous Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Uriya Harpeness' Miscellaneous Things
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Benefiting From Threading in Spite of the GIL in Python
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="dracula" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5M3.18 12a9.821 9.821 0 0 0 17.64 0 9.821 9.821 0 0 0-17.64 0Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/UriyaHarpeness/misc" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    misc
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Python
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Uriya Harpeness&#39; Miscellaneous Things" class="md-nav__button md-logo" aria-label="Uriya Harpeness' Miscellaneous Things" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Uriya Harpeness' Miscellaneous Things
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/UriyaHarpeness/misc" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    misc
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Benefiting From Threading in Spite of the GIL in Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Benefiting From Threading in Spite of the GIL in Python
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-scope" class="md-nav__link">
    The Scope
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#threadsasyncio" class="md-nav__link">
    Threads/Asyncio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#under-the-hood" class="md-nav__link">
    Under The Hood
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verifying-the-theory" class="md-nav__link">
    Verifying The Theory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#myth-busting" class="md-nav__link">
    Myth-Busting 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bonus" class="md-nav__link">
    Bonus
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-scope" class="md-nav__link">
    The Scope
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#threadsasyncio" class="md-nav__link">
    Threads/Asyncio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#under-the-hood" class="md-nav__link">
    Under The Hood
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verifying-the-theory" class="md-nav__link">
    Verifying The Theory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#myth-busting" class="md-nav__link">
    Myth-Busting 
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bonus" class="md-nav__link">
    Bonus
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="benefiting-from-threading-in-spite-of-the-gil-in-python">Benefiting From Threading in Spite of the GIL in Python<a class="headerlink" href="#benefiting-from-threading-in-spite-of-the-gil-in-python" title="Permanent link">&para;</a></h1>
<p>As many people use Python on a daily basis, I thought I'd share something that interested me for quite some time, and
very recently I finally took initiative to get to the bottom of.</p>
<div class="admonition note">
<p class="admonition-title">Disclaimer</p>
<p>This isn't about best practices or common use-cases, it's a bit deeper dive, to those who take interest in Python and
its internals (<em>very deep</em> internals) and care about how and why.</p>
<p>If it's not very interesting to you, it's totally cool, you can stop here, <code>exit()</code>.</p>
</div>
<h2 id="the-scope">The Scope<a class="headerlink" href="#the-scope" title="Permanent link">&para;</a></h2>
<p>The most wide-spread implementation of Python is CPython (written in C, duh), it's open-source, and here's the repo:
<a href="https://github.com/python/cpython">python/cpython</a>. That's where my research took place.</p>
<p>Note that currently Python 3.13 is underway (this document is written over CPython with
the <a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191">commit SHA of 557b05c</a>), and for
persistence the links are in relation to that specific commit, implementation may vary (greatly) with time, so the
specifics and possible change between versions are omitted, as this document is powered by curiosity alone.</p>
<h2 id="threadsasyncio">Threads/Asyncio<a class="headerlink" href="#threadsasyncio" title="Permanent link">&para;</a></h2>
<p>Python (currently) works with a single process that can share resources with multiple threads, it manages to do so with
the <a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">GIL</a> (Global Interpreter Lock), with each
thread awaiting its turn (<a href="https://peps.python.org/pep-0703/">PEP 703</a> anyone?).</p>
<p>Many of us have had some experience with async functions, especially in writing APIs or in the context of network
interaction, and expect the speedup of using it in specific areas, like communication with remote servers, writing logs,
etc.</p>
<p>While threads and asyncio aren't the same thing, both have ways of improving performance in certain areas, by allowing
other tasks to execute at the same time for specific operations.</p>
<p>This may raise a few questions, like <em>"Why do we get a speedup there?"</em> or <em>"How does Python know where to release the
GIL, and let other tasks resume?"</em>.</p>
<h2 id="under-the-hood">Under The Hood<a class="headerlink" href="#under-the-hood" title="Permanent link">&para;</a></h2>
<p>Well, there isn't such thing as magic (not if you go deep enough, which in some cases you simply shouldn't), so here's
the process I went through to look for an answer.</p>
<ol>
<li>
<p>I searched for something I know should have a blocking system call somewhere, like reading from a file, so naturally
   I went to <code>Lib/pathlib.py</code>, and
   specifically <a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Lib/pathlib.py#L971"><code>pathlib.Path.read_bytes()</code></a>.
   Which calls <code>pathlib.Path.open()</code>, which in turn calls <code>io.open()</code>, but looking at
   <a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Lib/io.py"><code>Lib/io.py</code></a> I couldn't
   see anything useful, so at this point, from my experience with CPython, I know I needed to look for the C code which
   actually performs the logic.</p>
</li>
<li>
<p>Conveniently enough, I found <code>Modules/_io/fileio.c</code> and the function inside
   it <a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Modules/_io/fileio.c#L798"><code>_io_FileIO_read_impl</code></a>,
   which in turn
   calls <a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Python/fileutils.c#L1847"><code>_Py_read</code></a>,
   and inside this function I stumbled upon something interesting...</p>
</li>
<li>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python/fileutils.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1846" name="__codelineno-0-1846"></a><span class="n">Py_ssize_t</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a><span class="nf">_Py_read</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a><span class="p">{</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a><span class="w">    </span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">async_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">PyGILState_Check</span><span class="p">());</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a><span class="w">    </span><span class="cm">/* _Py_read() must not be called with an exception set, otherwise the</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a><span class="cm">     * caller may think that read() was interrupted by a signal and the signal</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a><span class="cm">     * handler raised an exception. */</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">PyErr_Occurred</span><span class="p">());</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">_PY_READ_MAX</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a><span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_PY_READ_MAX</span><span class="p">;</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="w">    </span><span class="n">_Py_BEGIN_SUPPRESS_IPH</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="hll"><span class="w">        </span><span class="n">Py_BEGIN_ALLOW_THREADS</span>
</span><a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="w">        </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a><span class="cp">#ifdef MS_WINDOWS</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="w">        </span><span class="n">_doserrno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a><span class="hll"><span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
</span><a id="__codelineno-0-1871" name="__codelineno-0-1871"></a><span class="w">        </span><span class="c1">// read() on a non-blocking empty pipe fails with EINVAL, which is</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a><span class="w">        </span><span class="c1">// mapped from the Windows error code ERROR_NO_DATA.</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_doserrno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERROR_NO_DATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a><span class="w">                </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EAGAIN</span><span class="p">;</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a><span class="cp">#else</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a><span class="hll"><span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><a id="__codelineno-0-1880" name="__codelineno-0-1880"></a><span class="cp">#endif</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a><span class="w">        </span><span class="cm">/* save/restore errno because PyErr_CheckSignals()</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a><span class="cm">         * and PyErr_SetFromErrno() can modify it */</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a><span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">errno</span><span class="p">;</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a><span class="hll"><span class="w">        </span><span class="n">Py_END_ALLOW_THREADS</span>
</span><a id="__codelineno-0-1885" name="__codelineno-0-1885"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EINTR</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a><span class="w">            </span><span class="o">!</span><span class="p">(</span><span class="n">async_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyErr_CheckSignals</span><span class="p">()));</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a><span class="w">    </span><span class="n">_Py_END_SUPPRESS_IPH</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">async_err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a><span class="w">        </span><span class="cm">/* read() was interrupted by a signal (failed with EINTR)</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a><span class="cm">         * and the Python signal handler raised an exception */</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a><span class="w">        </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EINTR</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">PyErr_Occurred</span><span class="p">());</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a><span class="w">        </span><span class="n">PyErr_SetFromErrno</span><span class="p">(</span><span class="n">PyExc_OSError</span><span class="p">);</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a><span class="w">        </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>In lines 1866 and 1884 (highlighted) of the snippet above we see these two suspicious macros:
   <code>Py_BEGIN_ALLOW_THREADS</code> and <code>Py_END_ALLOW_THREADS</code> respectively, so I looked for where they're defined, which was
   <a href="https://github.com/python/cpython/blob/a1c737b73d3658be0e1d072a340d42e3d96373c6/Include/ceval.h#L65"><code>Include/ceval.h</code></a>,
   and above these functions the documentation says:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Include/ceval.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-65">65</a></span>
<span class="normal"><a href="#__codelineno-1-66">66</a></span>
<span class="normal"><a href="#__codelineno-1-67">67</a></span>
<span class="normal"><a href="#__codelineno-1-68">68</a></span>
<span class="normal"><a href="#__codelineno-1-69">69</a></span>
<span class="normal"><a href="#__codelineno-1-70">70</a></span>
<span class="normal"><a href="#__codelineno-1-71">71</a></span>
<span class="normal"><a href="#__codelineno-1-72">72</a></span>
<span class="normal"><a href="#__codelineno-1-73">73</a></span>
<span class="normal"><a href="#__codelineno-1-74">74</a></span>
<span class="normal"><a href="#__codelineno-1-75">75</a></span>
<span class="normal"><a href="#__codelineno-1-76">76</a></span>
<span class="normal"><a href="#__codelineno-1-77">77</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="cm">/* Interface for threads.</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="cm">   A module that plans to do a blocking system call (or something else</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="cm">   that lasts a long time and doesn&#39;t touch Python data) can allow other</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="cm">   threads to run as follows:</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a><span class="cm">   ...preparations here...</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="cm">   Py_BEGIN_ALLOW_THREADS</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="cm">   ...blocking system call here...</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="cm">   Py_END_ALLOW_THREADS</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="cm">   ...interpret result here...</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="cm">...</span>
</code></pre></div></td></tr></table></div>
</li>
<li>
<p>So it seemed I found what I was looking for, these two macros define the start and end of a blocking system call, and
   code written between these can benefit our async Python code.
   And indeed, between these macros in lines 1870 and 1879 (also highlighted) of the snippet above lies the
   syscall <a href="https://man7.org/linux/man-pages/man2/read.2.html">read</a>.</p>
</li>
<li>
<p>I admit I did not really go deeper than this, below these macros are the C functions implementation and usage of
   internal CPython structures, so this is as far as this specific journey went.</p>
</li>
</ol>
<h2 id="verifying-the-theory">Verifying The Theory<a class="headerlink" href="#verifying-the-theory" title="Permanent link">&para;</a></h2>
<p>I wanted to make sure I was right, and wanted to see another example of it in a different context where it makes sense,
and so I searched for these macros in CPython, and found them being used in <code>Modules/socketmodule.c</code> inside the function
<a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Modules/socketmodule.c#L972"><code>sock_call_ex</code></a>
(<em>call ex, hehe...</em>), which after some looking at the code seemed to be called with many socket related syscalls:
<a href="https://man7.org/linux/man-pages/man2/accept.2.html"><code>accept</code></a>,
<a href="https://man7.org/linux/man-pages/man2/connect.2.html"><code>connect</code></a>,
<a href="https://man7.org/linux/man-pages/man2/send.2.html"><code>send</code></a>,
<a href="https://man7.org/linux/man-pages/man2/recv.2.html"><code>recv</code></a>, and more.</p>
<p>This was indeed reassuring of the theory above, and I concluded my research happily.</p>
<h2 id="myth-busting">Myth-Busting <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 3.27 3.28 2 22 20.72 20.73 22l-2.86-2.87L15 22l-3-3-3 3-3-3-3 3V11c0-1.91.59-3.67 1.6-5.13L2 3.27M12 2a9 9 0 0 1 9 9v6.18l-5.3-5.3c.76-.29 1.3-1.02 1.3-1.88a2 2 0 0 0-2-2c-.86 0-1.59.54-1.87 1.3L7.2 3.38A8.946 8.946 0 0 1 12 2m-5 8a2 2 0 0 0 2 2c.5 0 .93-.17 1.27-.46L7.46 8.73C7.17 9.07 7 9.5 7 10Z"/></svg></span><a class="headerlink" href="#myth-busting" title="Permanent link">&para;</a></h2>
<p>Calling C code (or any other language) from Python does not guarantee concurrency, as written in Python's code about the
GIL: <em>"The mechanism used by the CPython interpreter to assure that only one thread executes Python bytecode at a
time"</em>.</p>
<p>The purpose is to protect Python data from being modified by several threads simultaneously, meaning that the release of
the GIL needs to be explicit, and of course, with much caution.</p>
<h2 id="bonus">Bonus<a class="headerlink" href="#bonus" title="Permanent link">&para;</a></h2>
<p>In <a href="https://github.com/python/cpython/blob/a1c737b73d3658be0e1d072a340d42e3d96373c6/Include/ceval.h#L107"><code>Include/ceval.h</code></a>
the macros were defined as:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Include/ceval.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-107">107</a></span>
<span class="normal"><a href="#__codelineno-2-108">108</a></span>
<span class="normal"><a href="#__codelineno-2-109">109</a></span>
<span class="normal"><a href="#__codelineno-2-110">110</a></span>
<span class="normal"><a href="#__codelineno-2-111">111</a></span>
<span class="normal"><a href="#__codelineno-2-112">112</a></span>
<span class="normal"><a href="#__codelineno-2-113">113</a></span>
<span class="normal"><a href="#__codelineno-2-114">114</a></span>
<span class="normal"><a href="#__codelineno-2-115">115</a></span>
<span class="normal"><a href="#__codelineno-2-116">116</a></span>
<span class="normal"><a href="#__codelineno-2-117">117</a></span>
<span class="normal"><a href="#__codelineno-2-118">118</a></span>
<span class="normal"><a href="#__codelineno-2-119">119</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="n">PyAPI_FUNC</span><span class="p">(</span><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PyEval_SaveThread</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a id="__codelineno-2-108" name="__codelineno-2-108"></a><span class="n">PyAPI_FUNC</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">PyEval_RestoreThread</span><span class="p">(</span><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<a id="__codelineno-2-109" name="__codelineno-2-109"></a>
<a id="__codelineno-2-110" name="__codelineno-2-110"></a><span class="n">PyAPI_FUNC</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">PyEval_AcquireThread</span><span class="p">(</span><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span><span class="n">tstate</span><span class="p">);</span>
<a id="__codelineno-2-111" name="__codelineno-2-111"></a><span class="n">PyAPI_FUNC</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">PyEval_ReleaseThread</span><span class="p">(</span><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span><span class="n">tstate</span><span class="p">);</span>
<a id="__codelineno-2-112" name="__codelineno-2-112"></a>
<a id="__codelineno-2-113" name="__codelineno-2-113"></a><span class="cp">#define Py_BEGIN_ALLOW_THREADS { \</span>
<a id="__codelineno-2-114" name="__codelineno-2-114"></a><span class="cp">                 PyThreadState *_save; \</span>
<a id="__codelineno-2-115" name="__codelineno-2-115"></a><span class="cp">                 _save = PyEval_SaveThread();</span>
<a id="__codelineno-2-116" name="__codelineno-2-116"></a><span class="cp">#define Py_BLOCK_THREADS      PyEval_RestoreThread(_save);</span>
<a id="__codelineno-2-117" name="__codelineno-2-117"></a><span class="cp">#define Py_UNBLOCK_THREADS     _save = PyEval_SaveThread();</span>
<a id="__codelineno-2-118" name="__codelineno-2-118"></a><span class="cp">#define Py_END_ALLOW_THREADS   PyEval_RestoreThread(_save); \</span>
<a id="__codelineno-2-119" name="__codelineno-2-119"></a><span class="cp">            }</span>
</code></pre></div></td></tr></table></div>
<p>I took a peek at <code>PyEval_SaveThread</code>, which I found in
<a href="https://github.com/python/cpython/tree/557b05c7a5334de5da3dc94c108c0121f10b9191/Python/ceval_gil.c#L729"><code>Python/ceval_gil.c</code></a>,
and there I saw:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python/ceval_gil.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-728">728</a></span>
<span class="normal"><a href="#__codelineno-3-729">729</a></span>
<span class="normal"><a href="#__codelineno-3-730">730</a></span>
<span class="normal"><a href="#__codelineno-3-731">731</a></span>
<span class="normal"><a href="#__codelineno-3-732">732</a></span>
<span class="normal"><a href="#__codelineno-3-733">733</a></span>
<span class="normal"><a href="#__codelineno-3-734">734</a></span>
<span class="normal"><a href="#__codelineno-3-735">735</a></span>
<span class="normal"><a href="#__codelineno-3-736">736</a></span>
<span class="normal"><a href="#__codelineno-3-737">737</a></span>
<span class="normal"><a href="#__codelineno-3-738">738</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-728" name="__codelineno-3-728"></a><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span>
<a id="__codelineno-3-729" name="__codelineno-3-729"></a><span class="nf">PyEval_SaveThread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-3-730" name="__codelineno-3-730"></a><span class="p">{</span>
<a id="__codelineno-3-731" name="__codelineno-3-731"></a><span class="w">    </span><span class="n">PyThreadState</span><span class="w"> </span><span class="o">*</span><span class="n">tstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_PyThreadState_SwapNoGIL</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-3-732" name="__codelineno-3-732"></a><span class="w">    </span><span class="n">_Py_EnsureTstateNotNULL</span><span class="p">(</span><span class="n">tstate</span><span class="p">);</span>
<a id="__codelineno-3-733" name="__codelineno-3-733"></a>
<a id="__codelineno-3-734" name="__codelineno-3-734"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">_ceval_state</span><span class="w"> </span><span class="o">*</span><span class="n">ceval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">interp</span><span class="o">-&gt;</span><span class="n">ceval</span><span class="p">;</span>
<a id="__codelineno-3-735" name="__codelineno-3-735"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">gil_created</span><span class="p">(</span><span class="n">ceval</span><span class="o">-&gt;</span><span class="n">gil</span><span class="p">));</span>
<a id="__codelineno-3-736" name="__codelineno-3-736"></a><span class="w">    </span><span class="n">drop_gil</span><span class="p">(</span><span class="n">ceval</span><span class="p">,</span><span class="w"> </span><span class="n">tstate</span><span class="p">);</span>
<a id="__codelineno-3-737" name="__codelineno-3-737"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tstate</span><span class="p">;</span>
<a id="__codelineno-3-738" name="__codelineno-3-738"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This gave me a glance at the existence of functions like <code>drop_gil</code>, <code>gil_created</code>, <code>destroy_gil</code>, and <code>take_gil</code>.
All there in that file.</p>
<p>So if anyone wants to go even deeper, here's where you can continue from.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>I like looking inside Python and see how it works. For me, it was a very interesting research, and I hope it was
interesting to you as well.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><em>"There's no such thing as magic!"</em> - Vernon Dursley, Harry Potter.</p>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.top", "navigation.instant", "navigation.sections", "content.code.copy"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>